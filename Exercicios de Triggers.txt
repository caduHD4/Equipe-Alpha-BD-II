ALUNOS: CARLOS EDUARDO MARIANO GARCIA PEREIRA, DIOGO MENESES DE FRANÇA e MARCOS FELIPE DA SILVA RIBEIRO
Exercícios de fixação - utilize o script do estudo de caso

01- Escreva quarto triggers de sintaxe - a trigger não precisa ter funcionalidade, basta não dar erro de sintaxe. Use variável global para testar.

- Faça uma declarando variáveis e com select into; 
SET @teste = 0;
DELIMITER // 
CREATE TRIGGER declarando_variaveis 
BEFORE
INSERT ON cliente FOR EACH ROW 
	BEGIN
		SELECT CPF_CNPJ FROM cliente WHERE cliente.id = 1 INTO @teste;
	END;
SELECT @teste; 
//
DELIMITER ;
- Faça a segunda com uma estrutura de decisão; 

SET @teste = "Erro";
DELIMITER // 
CREATE TRIGGER estrutura_decisao 
AFTER
INSERT ON cliente FOR EACH ROW 
	BEGIN
    	DECLARE CPF_CNPJ VARCHAR(100);
    	IF LENGTH(NEW.CPF_CNPJ) <= 14 THEN
		SET @teste = "Os dados são válidos";
	ELSE
		SET @teste = "Dados inválidos";
		END IF;
	END;
//
DELIMITER ;
SELECT @teste;



- Faça a terceira que gere erro, impedindo a ação;
DELIMITER //
CREATE TRIGGER checa_cpf
BEFORE INSERT ON cliente
FOR EACH ROW
BEGIN
      	IF LENGTH(NEW.CPF_CNPJ) > 11 THEN
                	SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "NÚMERO DE CARACTERES EXCEDIDO";
      	END IF;
END;
 
//
DELIMITER ;

- Faça a quarta que utilize a variável new e old - tente diferenciar. 

DELIMITER //
CREATE TRIGGER validar_alteracao_cliente_inativo
 BEFORE UPDATE ON cliente
 FOR EACH ROW
 BEGIN
     IF NEW.ativo <> OLD.ativo AND
        EXISTS(SELECT * FROM conta_receber WHERE CLIENTE_ID = NEW.id)
    THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ALTERAÇÃO INVÁLIDA - CLIENTE POSSUI DÍVIDA ';
     END IF;
 END
 //
DELIMITER ;

02- Uma trigger que tem a função adicionar a entrada de produtos no estoque deve ser associado para qual:

Tabela?
	
•	Tabela?
	R: ITEM_VENDA
	
• 	Tempo?

	R: AFTER
	
•	Evento?
	R: INSERT	
	
•	Precisa de variáveis? Quais?

	R: Não é necessário, pois a função no UPDATE já realiza todas as conexões com as tabelas.
	Implemente a trigger. 

DELIMITER // 
CREATE TRIGGER adicao_estoque
AFTER INSERT ON item_venda FOR EACH ROW
BEGIN 
	UPDATE produto SET estoque = estoque + OLD.quantidade WHERE produto.id = OLD.produto_id;
END;
//
DELIMITER ;
–teste
SELECT estoque FROM produto WHERE id = 1;

03- Uma trigger que tem a função criar um registro de auditoria quando um pagamento e recebimento for alterada deve ser associado para qual(is):


•	Tabela(s)?

	R:PAGAMENTO e RECEBIMENTO
•	Tempo?

	R:AFTER
•	Evento?
	
	R:UPDATE
•	Implemente a trigger (pode criar a tabela de auditoria)

CREATE TABLE auditoria_pagamento(
id INT NOT NULL AUTO_INCREMENT
, pagamento_id INT NOT NULL
, data_hora_alteracao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
,CONSTRAINT auditoria_pagamento_pk PRIMARY KEY (id)
);
 
CREATE TABLE auditoria_recebimento(
id INT NOT NULL AUTO_INCREMENT
, recebimento_id INT NOT NULL
, data_hora_alteracao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
,CONSTRAINT auditoria_recebimento_pk PRIMARY KEY (id)
);
 
DELIMITER //
CREATE TRIGGER monitora_pagamento
AFTER UPDATE ON pagamento
FOR EACH ROW
BEGIN
      	INSERT INTO auditoria_pagamento (pagamento_id) VALUES (NEW.pagamento.id);
END;
//
DELIMITER ;
 
DELIMITER //
CREATE TRIGGER monitora_recebimento
AFTER UPDATE ON recebimento
FOR EACH ROW
BEGIN
      	INSERT INTO auditoria_recebimento (recebimento_id) VALUES (NEW.recebimento.id);
END;
//
DELIMITER ;

04- Uma trigger que tem a função impedir a venda de um produto inferior a 50% do preço de venda deve ser associado para qual:



•	Tabela(s)?

	R:ITEM_VENDA
•	Tempo?

	R:BEFORE
•	Evento?
	
	R:INSERT
•	Implemente a trigger

DELIMITER // 
CREATE TRIGGER impedir_venda_produto_desconto
BEFORE INSERT ON item_venda FOR EACH ROW
BEGIN 
DECLARE preco_produto DECIMAL (8,2); 
    	DECLARE preco_unitario DECIMAL (8,2);
    
    SELECT preco_venda INTO preco_produto FROM produto WHERE id = NEW.produto_id;
    SELECT preco_unidade INTO preco_unitario FROM item_venda;
    
    IF preco_produto * 0.5 > preco_unitario THEN
		signal sqlstate '45000' set message_text = 'Valor de desconto inapropriado para venda';
	END IF;
END;
//
DELIMITER ;	
–teste
INSERT INTO item_venda(produto_id,venda_id,quantidade,preco_unidade) VALUES (1,1,4,27);

05- Este é para testar a sintaxe - tente implementar sem o script
Uma trigger que tem a função de gerar o RA automático na tabela ALUNO deve ser associada para qual

•	Tabela(s)?

	R:ALUNO
•	Tempo?

	R:BEFORE
•	Evento?
	
	R:INSERT
•	Precisa de variáveis? Quais?
	
	R:Sim é necessario.
•	Implemente a trigger - RA igual a concatenação do ano corrente, código do curso e o id do cadastro do aluno. 

DELIMITER //
CREATE TRIGGER ra_auto
BEFORE INSERT ON aluno 
FOR EACH ROW
BEGIN
DECLARE ra VARCHAR (200);
      	IF NEW.aluno_id THEN
		UPDATE aluno SET ra = CONCAT(NEW.DATA_CADASTRO(YYYY), NEW.curso_id, NEW.id);
END;
//
DELIMITER ;





